@if (product(); as p) {
<div class="product-detail">

    <!-- LEFT: Image Gallery — video first (if present), then images -->
    <div class="product-detail__viewer">
        <div class="pd-gallery">

            <!-- ── Main display area ─────────────────────────────────────── -->
            <div class="pd-gallery__main">

                @if (p.video && activeImage() === 0) {
                <!-- Video slide (slide 0) -->
                <video class="pd-gallery__main-video" [src]="p.video | safeUrl" autoplay [muted]="true" loop playsinline
                    preload="auto">
                </video>
                } @else {
                <!-- Image slides -->
                <img class="pd-gallery__main-img" [src]="p.images[imgIdx()]" [alt]="p.name"
                    onerror="this.onerror=null;this.src='assets/placeholder.svg'">
                }

                <!-- Prev / Next arrows (only when more than one slide) -->
                @if (totalSlides() > 1) {
                <button class="pd-gallery__arrow pd-gallery__arrow--prev"
                    (click)="activeImage.set((activeImage() - 1 + totalSlides()) % totalSlides())"
                    aria-label="Previous slide">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </button>
                <button class="pd-gallery__arrow pd-gallery__arrow--next"
                    (click)="activeImage.set((activeImage() + 1) % totalSlides())" aria-label="Next slide">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round">
                        <path d="M9 18l6-6-6-6" />
                    </svg>
                </button>

                <!-- Dot indicators -->
                <div class="pd-gallery__dots">
                    @for (i of totalSlidesArray(); track i) {
                    <button class="pd-gallery__dot" [class.active]="activeImage() === i" (click)="activeImage.set(i)"
                        [attr.aria-label]="'Slide ' + (i + 1)">
                    </button>
                    }
                </div>
                }
            </div>

            <!-- ── Thumbnail strip ──────────────────────────────────────── -->
            @if (totalSlides() > 1) {
            <div class="pd-gallery__thumbs">

                <!-- Video thumbnail (slide 0) -->
                @if (p.video) {
                <button class="pd-gallery__thumb pd-gallery__thumb--video" [class.active]="activeImage() === 0"
                    (click)="activeImage.set(0)" aria-label="Watch video">
                    <img [src]="p.images[0]" [alt]="p.name + ' — video'"
                        onerror="this.onerror=null;this.src='assets/placeholder.svg'">
                    <!-- Play icon overlay -->
                    <span class="pd-gallery__play-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                    </span>
                </button>
                }

                <!-- Image thumbnails (slides 1+) -->
                @for (img of p.images; track img; let i = $index) {
                <button class="pd-gallery__thumb" [class.active]="activeImage() === i + (p.video ? 1 : 0)"
                    (click)="activeImage.set(i + (p.video ? 1 : 0))" [attr.aria-label]="'View image ' + (i + 1)">
                    <img [src]="img" [alt]="p.name + ' — view ' + (i + 1)" loading="lazy"
                        onerror="this.onerror=null;this.src='assets/placeholder.svg'">
                </button>
                }
            </div>
            }

        </div>
    </div>

    <!-- RIGHT: Product Info -->
    <div class="product-detail__info">
        <div class="product-detail__info-inner">

            <!-- Breadcrumb -->
            <nav class="pd-breadcrumb">
                <a routerLink="/">Home</a>
                <span>›</span>
                <a routerLink="/shop">Collection</a>
                <span>›</span>
                <span>{{ p.name }}</span>
            </nav>

            <!-- Collection -->
            <span class="label pd-collection">{{ p.collection }}</span>

            <!-- Name -->
            <h1 class="pd-name">{{ p.name }}</h1>

            <!-- Rating -->
            <div class="pd-rating">
                <div class="pd-stars">
                    @for (s of stockStars; track s) {
                    <svg width="13" height="13" viewBox="0 0 24 24"
                        [attr.fill]="s <= Math.round(p.rating) ? '#C9A84C' : 'none'" stroke="#C9A84C"
                        stroke-width="1.5">
                        <polygon
                            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                    </svg>
                    }
                </div>
                <span class="pd-rating-text">{{ p.rating }} ({{ p.reviewCount }} reviews)</span>
            </div>

            <div class="pd-divider"></div>

            <!-- Price -->
            <div class="pd-pricing">
                <span class="pd-price">{{ p.price | currencyFormat }}</span>
                @if (p.originalPrice) {
                <span class="pd-original-price">{{ p.originalPrice | currencyFormat }}</span>
                }
            </div>
            <p class="pd-tax-note">Inclusive of all taxes</p>

            <div class="pd-divider"></div>

            <!-- Frame Color -->
            <div class="pd-option-group">
                <span class="pd-option-label">Frame Color — <em>{{ selectedColor()?.name }}</em></span>
                <div class="pd-swatches">
                    @for (color of p.frameColors; track color.name) {
                    <button class="pd-swatch" [style.background]="color.hex"
                        [class.active]="selectedColor()?.name === color.name" (click)="selectedColor.set(color)"
                        [attr.title]="color.name">
                    </button>
                    }
                </div>
            </div>

            <!-- Lens Shade -->
            <div class="pd-option-group">
                <span class="pd-option-label">Lens Shade — <em>{{ selectedLens()?.name }}</em></span>
                <div class="pd-swatches">
                    @for (lens of p.lensShades; track lens.name) {
                    <button class="pd-swatch" [style.background]="lens.hex"
                        [class.active]="selectedLens()?.name === lens.name" (click)="selectedLens.set(lens)"
                        [attr.title]="lens.name">
                    </button>
                    }
                </div>
            </div>

            <!-- Size -->
            <div class="pd-option-group">
                <span class="pd-option-label">Frame Size</span>
                <div class="pd-sizes">
                    @for (size of p.sizes; track size) {
                    <button class="pd-size-btn" [class.active]="selectedSize() === size"
                        (click)="selectedSize.set(size)">
                        {{ size }}
                    </button>
                    }
                </div>
            </div>

            <!-- Quantity -->
            <div class="pd-option-group">
                <span class="pd-option-label">Quantity</span>
                <div class="pd-qty">
                    <button (click)="decrementQty()">−</button>
                    <span>{{ quantity() }}</span>
                    <button (click)="incrementQty()">+</button>
                </div>
            </div>

            <div class="pd-divider"></div>

            <!-- CTA Buttons -->
            <div class="pd-actions">
                <button class="pd-btn-primary" [class.added]="addedToCart()" (click)="addToCart()">
                    @if (addedToCart()) {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    Added to Cart
                    } @else {
                    Add to Cart
                    }
                </button>
                <a routerLink="/checkout" class="pd-btn-secondary" (click)="addToCart()">
                    Buy Now
                </a>
            </div>

            <div class="pd-divider"></div>

            <!-- Accordion: Product Details -->
            <div class="pd-accordion" [class.open]="detailsOpen()">
                <button class="pd-accordion__heading" (click)="toggleDetails()">
                    <span>Product Details</span>
                    <span class="pd-accordion__icon">{{ detailsOpen() ? '−' : '+' }}</span>
                </button>
                <div class="pd-accordion__body">
                    <p class="pd-description">{{ p.description }}</p>
                    <ul class="pd-specs">
                        @for (spec of p.specs; track spec.label) {
                        <li class="pd-spec">
                            <span class="pd-spec__label">{{ spec.label }}</span>
                            <span class="pd-spec__value">{{ spec.value }}</span>
                        </li>
                        }
                    </ul>
                </div>
            </div>

            <!-- Accordion: Shipping -->
            <div class="pd-accordion" [class.open]="shippingOpen()">
                <button class="pd-accordion__heading" (click)="toggleShipping()">
                    <span>Shipping & Returns</span>
                    <span class="pd-accordion__icon">{{ shippingOpen() ? '−' : '+' }}</span>
                </button>
                <div class="pd-accordion__body">
                    <p>Free shipping on orders above ₹ 2,999. Standard delivery in 3–5 business days.</p>
                    <p style="margin-top:8px">Easy 15-day returns on unused items in original packaging. Prescription
                        lenses are non-returnable.</p>
                </div>
            </div>

        </div>
    </div>
</div>
} @else {
<div class="pd-loading container">
    <p>Loading product...</p>
</div>
}